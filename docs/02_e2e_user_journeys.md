# E2Eテスト ユーザージャーニー仕様書

## 概要

本文書は、クイズアプリケーションのE2Eテストで検証すべきユーザージャーニーを定義します。
Kent C. Doddsの「ユーザーが使うようにテストする」哲学に基づき、実際のユーザー視点でのシナリオを記述します。

## ユーザージャーニー一覧

### 1. 完全なクイズ体験（complete-quiz-journey）

**ユーザーストーリー**: 「クイズを選んで最後まで解いて結果を見る」

#### ユーザーフロー
1. **カテゴリ選択**
   - ホーム画面で利用可能なクイズカテゴリを確認
   - カテゴリの進捗状況（未開始/進行中/完了）を確認
   - 任意のカテゴリの「開始」ボタンをクリック

2. **クイズ実行**
   - 問題文と選択肢を読む
   - 回答を選択（単一選択/複数選択）
   - 「回答する」ボタンをクリック
   - 正解・不正解のフィードバックと解説を確認
   - 次の問題に進む、または結果画面へ

3. **結果確認**
   - 正解率とパフォーマンス評価を確認
   - 統計情報（正解数、不正解数、総問題数）を確認
   - 問題別の結果詳細を確認
   - 「復習する」「再挑戦」「ホームに戻る」から選択

#### テストパターン
- **全問正解パターン**: 100%の成績で「素晴らしい！」メッセージ、復習ボタンなし
- **正解・不正解混在パターン**: 50%の成績で「復習が必要です」メッセージ、復習ボタン表示

### 2. 間違えた問題の復習（review-mistakes）

**ユーザーストーリー**: 「間違えた問題を復習して理解を深める」

#### ユーザーフロー
1. **復習画面アクセス**
   - ホーム画面で「復習する」ボタンをクリック
   - 復習モード画面で復習対象の統計を確認

2. **復習実行**
   - 「復習を開始する」ボタンをクリック
   - 間違えた問題に再挑戦
   - 正解・不正解のフィードバックを確認

3. **復習結果確認**
   - 復習後の統計情報を確認
   - 正解した問題は復習リストから削除
   - 復習対象がなくなると完了メッセージ表示

#### テストパターン  
- **正解パターン**: 復習対象から問題が削除され、復習ボタンが非表示
- **不正解パターン**: 間違い回数が増加し、復習対象として残る

### 3. クイズの中断と再開（resume-quiz）

**ユーザーストーリー**: 「中断したクイズを後で続ける」

#### ユーザーフロー  
1. **クイズ開始と中断**
   - カテゴリを選択してクイズを開始
   - 途中まで問題を回答
   - 「ホーム」ボタンで中断

2. **進捗状態の確認**
   - ホーム画面で該当カテゴリが「進行中」状態になっている
   - 進捗表示（例：1/2）が正しく表示される
   - 「続きから」ボタンが表示される

3. **クイズ再開**
   - 「続きから」ボタンをクリック
   - 次の未回答問題から再開される
   - 残りの問題を完了して結果画面へ

4. **完了後の状態変化**  
   - カテゴリが「完了」状態になる
   - 「最初から」ボタンに変更される

#### テストパターン
- **単一カテゴリ再開**: 1つのカテゴリで中断・再開
- **複数カテゴリ管理**: 複数カテゴリで独立した進捗管理
- **ブラウザセッション永続化**: リロード後も進捗が維持される

### 4. 復習リスト更新機能（review-list-update）

**ユーザーストーリー**: 「クイズを再挑戦した結果に応じて復習リストが正しく更新される」

#### ユーザーフロー
1. **初回クイズ実施で不正解を作る**
   - カテゴリを選択してクイズを開始
   - 一部の問題を不正解にしてクイズを完了
   - ホーム画面で「復習推奨問題があります」メッセージ表示を確認

2. **クイズ再挑戦で全問正解**
   - 該当カテゴリの「最初から」ボタンをクリック  
   - 同じクイズを今度は全問正解で完了
   - ホーム画面で復習推奨メッセージが消えることを確認

3. **クイズ再挑戦で異なる問題を不正解**
   - 今度は別の問題を不正解にしてクイズを完了
   - 復習リストが新しい不正解問題に更新されることを確認

4. **複数カテゴリでの独立性確認**
   - 複数のカテゴリでそれぞれ不正解を作る
   - 1つのカテゴリのみ再挑戦して全問正解
   - そのカテゴリの復習推奨は消えるが他のカテゴリは残ることを確認

#### テストパターン
- **復習リストクリア**: 全問正解で復習推奨が完全に消える
- **復習リスト更新**: 新しい不正解問題で復習リストが更新される  
- **カテゴリ独立性**: 他のカテゴリの復習リストに影響しない

## テスト実装ガイドライン

### E2Eテストの焦点
- **ユーザー操作**: クリック、入力、ナビゲーションなど実際のユーザー行動
- **画面表示**: ユーザーに表示される情報の正確性
- **フロー完遂**: 開始から完了までの一連の流れ

### 技術的詳細の除外
- データベース・LocalStorageの内部構造
- APIレスポンスの詳細仕様  
- フロントエンドの状態管理実装

## 5. 実際に発生した問題事例

### 5.1 Issue #10: クイズ再開時の問題（2025-08-09修正）
- **現象**: 「続きから」でクイズを再開すると、回答済みの問題から再開される
- **原因**: `currentQuestionIndex`と`answers.length`の非同期による状態不整合
- **E2Eテストでの検証**: resume-quizシナリオで実際のユーザーフローをテスト

### 5.2 UIアクセシビリティ問題（2025-08-10修正）
- **現象**: アイコンの視認性が悪く、テーマ色との相性が悪い
- **原因**: DaisyUIカラーシステムの不適切な使用
- **E2Eテストでの検証**: 実際のブラウザ表示での視認性確認

### 5.3 データ整合性問題
- **現象**: 進捗率が100%を超えて表示される（例: 3/2）
- **原因**: 複数箇所での異なる完了判定ロジック
- **E2Eテストでの検証**: 進捗表示の正確性をユーザー視点で検証

### 5.4 UI表示の整合性問題
- **現象**: 選択肢の表示方法が統一されていない  
- **原因**: 回答前アイコンの視認性問題
- **解決**: 背景色変化による選択状態表現への統一

### 5.5 Issue #31: 復習リスト更新バグ（2025-08-11修正）
- **現象**: クイズ再挑戦で全問正解しても復習推奨問題が残存する
- **原因**: クイズ完了時に復習リストが更新されない設計上の欠陥
- **解決**: `updateReviewListOnCompletion`メソッドによる完了時復習リスト更新
- **UI改善**: ボタンラベル「もう一度」→「最初から」でユーザーの理解を向上
- **E2Eテストでの検証**: review-list-updateシナリオで復習リスト更新の完全なフロー検証

## 6. E2Eテストの価値

E2Eテストは以下の実際の問題発見に貢献しました：
- **ユーザー体験の検証**: 実装は正しくてもUXに問題がある場合の発見
- **データフローの検証**: コンポーネント間のデータ受け渡しの問題発見
- **視覚的品質の確認**: アクセシビリティやデザイン問題の発見

各テストの具体的な実装は `e2e/` ディレクトリ内のPlaywrightテストコードを参照してください。
